const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/react-plotly-BSXlLkWf.js","assets/index-D1FBr1Rb.js","assets/index-Cax-Ei_R.css"])))=>i.map(i=>d[i]);
import{k as nt,u as n,C as st,a as ut,D as ct,O as it,_ as mt,e as G,d as M,w as g,B as k}from"./index-D1FBr1Rb.js";import{c as B,l as Y,i as J,N as ht,P as F}from"./param-grid-DRZXAFhC.js";import{T as pt}from"./tool-title-CEu85KTp.js";class dt extends nt{constructor(){super(...arguments),this.state={hasError:!1}}static getDerivedStateFromError(e){return{hasError:!0,error:e}}componentDidCatch(e,r){console.error("Plotly error:",e,r)}render(){return this.state.hasError?n("div",{className:"rounded-md bg-red-50 p-4 text-sm text-red-500 dark:bg-red-950 dark:text-red-400",children:"Failed to render plot. Please try refreshing the page."}):this.props.children}}const vt=it(()=>mt(()=>import("./react-plotly-BSXlLkWf.js").then(t=>t.r),__vite__mapDeps([0,1,2]))),gt=({x:t,yMin:e=0,yMax:r,color:l="gray",width:a=.75,dash:c="dot"})=>({type:"line",x0:t,x1:t,y0:e,y1:r,line:{color:l,width:a,dash:c}}),_t=({x:t,label:e,yref:r="paper",xshift:l=-3,yshift:a=-15,y:c=1,textAngle:o="-90",xanchor:i="right",yanchor:m="top"})=>({text:e,x:t,xshift:l,yshift:a,y:c,yref:r,textangle:o,xanchor:i,yanchor:m,showarrow:!1}),ft=({y:t,xMin:e=0,xMax:r=100,color:l="gray",width:a=.75,dash:c="dot"})=>({type:"line",x0:e,x1:r,y0:t,y1:t,line:{color:l,width:a,dash:c}}),Tt=({className:t})=>n("div",{className:G("flex h-full w-full items-center justify-center rounded-xl bg-muted/20",t),children:n("div",{className:"animate-pulse",children:"Loading plot..."})}),N=st(({data:t,layout:e,className:r})=>{const{theme:l}=ut(),a=l==="dark"?"#09090b":"#ffffff",c=l==="dark"?"#fafafa":"#18181b",o=l==="dark"?"#27272a":"#e4e4e7",i=l==="dark"?"#a1a1aa":"#18181b",m={paper_bgcolor:a,plot_bgcolor:a,font:{color:c},legend:{itemclick:!1,itemdoubleclick:!1},margin:{b:42,l:55,r:10,t:30},xaxis:{gridcolor:o,zeroline:!1,showline:!0,linecolor:i,mirror:!0},yaxis:{gridcolor:o,zeroline:!1,showline:!0,linecolor:i,mirror:!0},showlegend:!0},f={...m,...e,font:{...m.font,...e.font},legend:{...m.legend,...e.legend},margin:{...m.margin,...e.margin},xaxis:{...m.xaxis,...e.xaxis},yaxis:{...m.yaxis,...e.yaxis}},v=t.map(P=>({type:"scatter",mode:"lines",...P}));return n(dt,{children:n(ct,{fallback:n(Tt,{className:r}),children:n(vt,{data:v,layout:f,useResizeHandler:!0,className:G("h-full w-full",r),config:{displaylogo:!1}})})})});Object.defineProperty(N,"displayName",{value:"PlotlyPlot"});function $(t,e){const r=t.length;let l=new Array(r);for(let a=0;a<r;a++)l[a]=t[a]*e;return l}function wt(t,e){const r=t.length;let l=new Array(r);for(let a=0;a<r;a++)l[a]=t[a]+e;return l}function Mt(t){const e=t.length;let r=0;for(let l=0;l<e;l++)r+=t[l];return r}function xt(t){return Mt(t)/t.length}function q(t,e,r){const l=Math.floor((e-t)/r)+1;let a=t,c=new Array(l);for(let o=0;o<l;o++)c[o]=a,a+=r;return c}function X(t,e,r){const l=r.length;let a=new Array(l);const c=e.length-1;let o=0;for(let i=0;i<l;i++){if(r[i]<=e[0]){a[i]=t[0];continue}if(r[i]>=e[c]){a[i]=t[c];continue}for(o;o<c;o++)if(r[i]<e[o+1]){const m=(r[i]-e[o])/(e[o+1]-e[o]);a[i]=t[o]+(t[o+1]-t[o])*m;break}}return a}const Ot=[{pwm:1e3,thrust:.196,voltage:21.72,current:.042},{pwm:1001,thrust:.196,voltage:21.72,current:.042},{pwm:1012,thrust:.196,voltage:21.72,current:.041},{pwm:1024,thrust:.196,voltage:21.72,current:.041},{pwm:1038,thrust:.196,voltage:21.72,current:.042},{pwm:1051,thrust:.196,voltage:21.72,current:.042},{pwm:1065,thrust:.196,voltage:21.72,current:.042},{pwm:1078,thrust:.197,voltage:21.72,current:.046},{pwm:1092,thrust:.204,voltage:21.71,current:.315},{pwm:1105,thrust:.237,voltage:21.72,current:.23},{pwm:1118,thrust:.245,voltage:21.72,current:.178},{pwm:1130,thrust:.25,voltage:21.72,current:.187},{pwm:1145,thrust:.261,voltage:21.72,current:.217},{pwm:1158,thrust:.271,voltage:21.72,current:.238},{pwm:1172,thrust:.287,voltage:21.72,current:.297},{pwm:1186,thrust:.303,voltage:21.72,current:.311},{pwm:1198,thrust:.314,voltage:21.71,current:.354},{pwm:1212,thrust:.335,voltage:21.71,current:.428},{pwm:1225,thrust:.358,voltage:21.71,current:.482},{pwm:1239,thrust:.378,voltage:21.71,current:.547},{pwm:1252,thrust:.398,voltage:21.71,current:.608},{pwm:1266,thrust:.418,voltage:21.71,current:.665},{pwm:1279,thrust:.439,voltage:21.71,current:.722},{pwm:1292,thrust:.451,voltage:21.71,current:.771},{pwm:1306,thrust:.472,voltage:21.71,current:.849},{pwm:1319,thrust:.514,voltage:21.7,current:1.025},{pwm:1332,thrust:.546,voltage:21.7,current:1.11},{pwm:1346,thrust:.574,voltage:21.7,current:1.191},{pwm:1360,thrust:.6,voltage:21.7,current:1.302},{pwm:1373,thrust:.624,voltage:21.7,current:1.391},{pwm:1386,thrust:.647,voltage:21.7,current:1.493},{pwm:1400,thrust:.672,voltage:21.7,current:1.584},{pwm:1414,thrust:.699,voltage:21.69,current:1.704},{pwm:1429,thrust:.726,voltage:21.69,current:1.796},{pwm:1443,thrust:.748,voltage:21.69,current:1.919},{pwm:1457,thrust:.774,voltage:21.69,current:2.05},{pwm:1470,thrust:.804,voltage:21.69,current:2.192},{pwm:1484,thrust:.838,voltage:21.69,current:2.369},{pwm:1498,thrust:.872,voltage:21.69,current:2.513},{pwm:1512,thrust:.915,voltage:21.68,current:2.788},{pwm:1526,thrust:.964,voltage:21.67,current:3.025},{pwm:1540,thrust:1.001,voltage:21.67,current:3.215},{pwm:1555,thrust:1.039,voltage:21.68,current:3.482},{pwm:1568,thrust:1.082,voltage:21.67,current:3.699},{pwm:1583,thrust:1.113,voltage:21.67,current:3.851},{pwm:1596,thrust:1.15,voltage:21.66,current:4.103},{pwm:1609,thrust:1.184,voltage:21.66,current:4.386},{pwm:1623,thrust:1.224,voltage:21.65,current:4.57},{pwm:1636,thrust:1.261,voltage:21.65,current:4.808},{pwm:1650,thrust:1.289,voltage:21.65,current:5},{pwm:1664,thrust:1.321,voltage:21.64,current:5.245},{pwm:1676,thrust:1.352,voltage:21.65,current:5.509},{pwm:1690,thrust:1.388,voltage:21.64,current:5.748},{pwm:1704,thrust:1.428,voltage:21.63,current:6.026},{pwm:1717,thrust:1.463,voltage:21.63,current:6.275},{pwm:1730,thrust:1.493,voltage:21.62,current:6.564},{pwm:1746,thrust:1.519,voltage:21.62,current:6.887},{pwm:1759,thrust:1.554,voltage:21.62,current:7.172},{pwm:1773,thrust:1.596,voltage:21.61,current:7.481},{pwm:1786,thrust:1.637,voltage:21.61,current:7.821},{pwm:1800,thrust:1.674,voltage:21.6,current:8.143},{pwm:1814,thrust:1.711,voltage:21.6,current:8.469},{pwm:1827,thrust:1.742,voltage:21.59,current:8.812},{pwm:1840,thrust:1.774,voltage:21.59,current:9.125},{pwm:1854,thrust:1.809,voltage:21.58,current:9.423},{pwm:1867,thrust:1.846,voltage:21.58,current:9.784},{pwm:1881,thrust:1.882,voltage:21.57,current:10.161},{pwm:1895,thrust:1.936,voltage:21.56,current:10.602},{pwm:1909,thrust:1.987,voltage:21.56,current:10.993},{pwm:1923,thrust:2.028,voltage:21.55,current:11.387},{pwm:1937,thrust:2.07,voltage:21.55,current:11.823},{pwm:1950,thrust:2.107,voltage:21.54,current:12.235},{pwm:1963,thrust:2.152,voltage:21.53,current:12.671},{pwm:1977,thrust:2.195,voltage:21.53,current:13.078},{pwm:1989,thrust:2.233,voltage:21.52,current:13.511},{pwm:2e3,thrust:2.254,voltage:21.52,current:13.854}],yt=.005,C=.001,w=q(0,1,C),K=(t,e,r,l,a,c)=>{function o(s,y,E){return s<y?y:s>E?E:s}function i(s){return s==0}function m(s){return Math.sqrt(s)}function f(s){const T=o(t,-1,1);if(i(T))return 1*s*1;const ot=(T-1+m((1-T)*(1-T)+4*T*1*s))/(2*T);return o(ot*1,0,1)}function v(s){return s=o(s,0,1),e+(r-e)*f(s)}function P(s){return l+(a-l)*s}const x=w.length;let L=new Array(x);for(let s=0;s<x;s++){const y=v(w[s]);L[s]=P(y)}const A=X(c.thrust,c.pwm,L);let O=new Array(x-1);for(let s=0;s<x-1;s++)O[s]=(A[s+1]-A[s])/C;const W=xt(O);let z=0;for(let s=0;s<x-1;s++)z+=(O[s]-W)**2;const lt=Math.sqrt(z/O.length);return{corrected_thrust:A,gradient:O,mean:W,std_deviation:lt,expo:t}},Pt=(t,e,r,l,a)=>q(-1,1,yt).reduce((o,i)=>{const m=K(i,t,e,r,l,a);return!o||m.std_deviation<o.std_deviation?m:o},null),Q={pwm:0,thrust:0,voltage:0,current:0},_={MOT_PWM_MIN:1e3,MOT_PWM_MAX:2e3,MOT_SPIN_ARM:.1,MOT_SPIN_MIN:.15,MOT_SPIN_MAX:.95,MOT_THST_EXPO:.65},U={MOT_THST_HOVER:0},Z={MOT_THST_HOVER:!0},tt={MOT_THST_EXPO:!1},S=M([]),u=B(),et=M([]),d=B(),I=M(!0),Nt=M(!0),h=M(Array(10).fill(null).map(()=>({...Q}))),H=M(!0),V=(t,e=(...r)=>JSON.stringify(r))=>{const r=new Map;return(...l)=>{const a=e(...l);if(r.has(a))return r.get(a);const c=t(...l);return r.set(a,c),c}},b=(t,e,r)=>e+(r-e)*t,St=()=>Ot.map(t=>({pwm:t.pwm,thrust:t.thrust,voltage:t.voltage,current:t.current})),rt=g(()=>h.value.reduce((t,e)=>Math.max(t,e.thrust),0)||1),R=g(()=>{const t=d.value["Number of motors"],e=d.value["All-up weight (AUW)"];return t>0&&e>0?e/t:0}),at=g(()=>S.value.length===0||h.value.length===0?!1:h.value.some(t=>t.thrust>0&&t.pwm>0)),At=t=>{if(!t||typeof t!="object")return!1;const e=t;return typeof e.pwm=="number"&&typeof e.thrust=="number"&&typeof e.voltage=="number"&&typeof e.current=="number"},D=t=>{try{if(!Array.isArray(t)||!t.every(At))throw new Error("invalid thrust data format");h.value=t,H.value=!0}catch(e){console.error("failed to update thrust data:",e)}},j=t=>{if(R.value>0){const e=X(w,t,[R.value])[0],r=Number(e.toFixed(3));Math.abs(r-d.value.MOT_THST_HOVER)>.001&&(d.value.MOT_THST_HOVER=r)}},Et=()=>{D(St()),d.value["All-up weight (AUW)"]=2.5},bt=()=>{D(Array(10).fill(null).map(()=>({...Q}))),u.value.MOT_PWM_MIN=_.MOT_PWM_MIN,u.value.MOT_PWM_MAX=_.MOT_PWM_MAX,u.value.MOT_SPIN_ARM=_.MOT_SPIN_ARM,u.value.MOT_SPIN_MIN=_.MOT_SPIN_MIN,u.value.MOT_SPIN_MAX=_.MOT_SPIN_MAX,u.value.MOT_THST_EXPO=_.MOT_THST_EXPO,d.value["Number of motors"]=4,d.value["All-up weight (AUW)"]=0,d.value.MOT_THST_HOVER=0},It=g(()=>{if(!at.value)return[];const t=h.value,e=t.length,r=new Array(e),l=new Array(e);for(let a=0;a<e;a++)r[a]=t[a].pwm,l[a]=t[a].thrust;return[{x:r,y:l,name:"Measured Thrust"}]}),Ht=V(K),Rt=V(Pt),p=g(()=>{if(!at.value)return null;const t={pwm:h.value.map(r=>r.pwm),thrust:h.value.map(r=>r.thrust),voltage:h.value.map(r=>r.voltage),current:h.value.map(r=>r.current)};if(H.value){const r=Rt(u.value.MOT_SPIN_MIN,u.value.MOT_SPIN_MAX,u.value.MOT_PWM_MIN,u.value.MOT_PWM_MAX,t);return r.expo!==void 0&&!isNaN(r.expo)&&(H.value=!1,u.value.MOT_THST_EXPO=Number(r.expo.toFixed(3))),j(r.corrected_thrust),r}const e=Ht(u.value.MOT_THST_EXPO,u.value.MOT_SPIN_MIN,u.value.MOT_SPIN_MAX,u.value.MOT_PWM_MIN,u.value.MOT_PWM_MAX,t);return j(e.corrected_thrust),e}),Xt=g(()=>p.value?[{x:$(wt(w.slice(0,-1),C*.5),100),y:p.value.gradient,name:`Linearized Thrust<br>Std dev: ${p.value.std_deviation.toFixed(3)}`,line:{color:"indianred"}}]:[]),Ct=g(()=>p.value?{xaxis:{title:"Throttle (%)",range:[0,100]},yaxis:{title:"Thrust gradient (delta thrust / delta throttle)"},showlegend:!0,shapes:p.value.mean?[ft({y:p.value.mean,color:"gray",dash:"4px,3px"})]:[]}:{xaxis:{title:"Throttle (%)"},yaxis:{title:"Thrust gradient (delta thrust / delta throttle)"}}),Vt=V(X),Dt=g(()=>{if(!p.value)return[];const t={pwm:h.value.map(v=>v.pwm),thrust:h.value.map(v=>v.thrust)},e=t.pwm.map(v=>((v-u.value.MOT_PWM_MIN)/(u.value.MOT_PWM_MAX-u.value.MOT_PWM_MIN)-u.value.MOT_SPIN_MIN)/(u.value.MOT_SPIN_MAX-u.value.MOT_SPIN_MIN)),r=Vt(t.thrust,e,w),l=$(w,100),a=Math.max(...p.value.corrected_thrust),c=p.value.corrected_thrust[0],o=a-c,i=l.map(v=>c+o*v/100),m=[{x:l,y:r,name:"Measured Thrust"},{x:l,y:p.value.corrected_thrust,name:"Linearized Thrust"},{x:l,y:i,name:"Ideal Response",line:{dash:"4px,3px",width:1,color:"gray"}}],f=d.value.MOT_THST_HOVER*100;return f>=0&&f<=100&&m.push({x:[f],y:[R.value],name:"THST_HOVER",mode:"markers",marker:{size:8,symbol:"circle",color:"green"}}),m}),Lt=g(()=>{const{MOT_PWM_MIN:t,MOT_PWM_MAX:e}=u.value;return{pwmSpinArm:b(u.value.MOT_SPIN_ARM,t,e),pwmSpinMin:b(u.value.MOT_SPIN_MIN,t,e),pwmSpinMax:b(u.value.MOT_SPIN_MAX,t,e)}}),Wt=g(()=>{if(S.value.length===0)return{xaxis:{title:"ESC Signal (μs)"},yaxis:{title:"Thrust"}};const{pwmSpinArm:t,pwmSpinMin:e,pwmSpinMax:r}=Lt.value,l=rt.value,a=[{x:t,color:"orange",label:"MOT_SPIN_ARM"},{x:e,color:"green",label:"MOT_SPIN_MIN"},{x:r,color:"red",label:"MOT_SPIN_MAX"}];return{xaxis:{title:"ESC Signal (μs)",range:[u.value.MOT_PWM_MIN,u.value.MOT_PWM_MAX]},yaxis:{title:"Thrust",range:[0,l]},shapes:a.map(({x:c,color:o})=>gt({x:c,yMax:l,color:o})),annotations:a.map(({x:c,label:o})=>_t({x:c,label:o}))}}),zt=g(()=>({xaxis:{title:"Throttle (%)",range:[0,100]},yaxis:{title:"Thrust",range:[0,rt.value]},showlegend:!0}));Y(Object.keys(_),_,Z,tt).then(t=>{S.value=t,u.value=J(t)}).catch(t=>{console.error("failed to load thrust expo parameters:",t)}).finally(()=>{I.value=!1});Y(Object.keys(U),U,Z,tt).then(t=>{t.splice(0,0,{Name:"Number of motors",Desc:"Number of thrust producing motors",Value:4,Range:{low:1,high:12}}),t.splice(1,0,{Name:"All-up weight (AUW)",Desc:"All-up weight including battery and payload. Must be same units as thrust data.",Value:0}),et.value=t,d.value=J(t)}).catch(t=>{console.error("Failed to load hover parameters:",t)}).finally(()=>{Nt.value=!1});const kt=[{field:"pwm",headerName:"ESC Signal (μs)",precision:0},{field:"thrust",headerName:"Thrust",precision:3},{field:"voltage",headerName:"Voltage (V)",precision:3},{field:"current",headerName:"Current (A)",precision:3}],Gt=()=>n("div",{className:"flex min-w-[580px] flex-row flex-wrap gap-3 pb-8",children:[n("div",{className:"w-full max-w-screen-xl",children:[n(pt,{title:"ArduPilot Thrust Expo",children:"This tool estimates thrust linearization using thrust test stand data. Load a parameter file or enter parameters manually. Copy and paste test stand data from a spreadsheet or enter it manually. Current data is optional (for reference only - not used in calculation). Once the plot is generated, adjust MOT_THST_EXPO to improve the linear fit. If the curve is poorly matched at the extremes, do not chase a perfect fit. Rather, focus on midrange throttle linearity."}),n("div",{className:"flex flex-col gap-3 px-3",children:[n(ht,{title:"Thrust Data",description:"Paste test stand data or drag and drop a CSV or delimited text file.",columns:kt,rows:h,onDataChange:D}),n("div",{className:"flex w-full flex-row flex-wrap justify-between gap-3",children:[n(F,{paramConfig:S,params:u,isLoading:I.value,description:"Manually enter parameters or drag and drop a parameter file.",className:"min-w-[550px] flex-1 basis-[550px]",variant:"narrow"}),n("div",{className:"flex min-w-[550px] flex-1 basis-[550px] flex-col",children:[n("div",{className:"flex-none",children:n(F,{title:"Hover Thrust Estimation",paramConfig:et,params:d,isLoading:I.value,description:"Optional: Enter number of motors and total mass to estimate hover thrust. Use MOT_HOVER_LEARN rather than setting the estimated value explicitly. The learned value may be useful to help validate the generated thrust curve.",variant:"narrow",suppressToolbar:!0})}),n("div",{className:"flex flex-1 flex-col",children:[p.value&&n("div",{className:"text-sm pt-3 pl-2 pb-2",children:n("div",{className:"flex flex-col gap-1",children:[n("div",{className:"font-semibold",children:"Calculated Values :"}),n("div",{className:"flex gap-4 text-muted-foreground",children:[n("div",{children:["MOT_THST_EXPO: ",u.value.MOT_THST_EXPO.toFixed(3)]}),n("div",{children:["MOT_THST_HOVER: ",d.value.MOT_THST_HOVER.toFixed(3)]})]}),n("div",{className:"text-muted-foreground",children:["StdDev: ",p.value.std_deviation.toFixed(3)]})]})}),n("div",{className:"flex flex-1 flex-col justify-end",children:n("div",{className:"flex gap-3",children:[n(k,{variant:"outline",onClick:Et,children:"Show Example"}),n(k,{variant:"outline",onClick:bt,children:"Reset All"})]})})]})]})]})]})]}),n("div",{className:"flex w-full max-w-screen-xl flex-col gap-3",children:[n(N,{className:"h-[450px] w-full",data:It.value,layout:Wt.value}),n(N,{className:"h-[450px] w-full",data:Dt.value,layout:zt.value}),n(N,{className:"h-[450px] w-full",data:Xt.value,layout:Ct.value})]})]});export{Gt as ThrustExpo,Gt as default};
